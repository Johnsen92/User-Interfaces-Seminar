// Database connection
var con = null;
var module_name = "default";
var init_flag = false;

// Set database connection
function init(name, database_connection){
  con = database_connection;
  module_name = name;
  init_flag = true;
}

function getAllExercises(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  con.query("SELECT * FROM exercise", (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		res.send(JSON.stringify(result));
	});
};

function getExercise(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
	con.query("SELECT * FROM exercise WHERE ExerciseID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("ExerciseID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify(result));
	});
};

function postExercise(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`INSERT INTO exercise (UserID, ExerciseName, ExerciseType) VALUES (
      '${req.body.UserID}',
      '${req.body.ExerciseName}',
      '${req.body.ExerciseType}')`
    );
    con.query(`SELECT * FROM exercise ORDER BY ExerciseID DESC LIMIT 1`, (err, result) => {
      res.send(JSON.stringify(result));        
    });
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

function deleteExercise(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  con.query("DELETE FROM exercise WHERE ExerciseID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("ExerciseID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify("Success"));
	});
};

function putExercise(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`UPDATE exercise SET
      UserID = '${req.body.UserID}',
      ExerciseName ='${req.body.ExerciseName}',
      ExerciseType = '${req.body.ExerciseType}'
      WHERE ExerciseID = ${req.body.ExerciseID}`
    );
    res.send(req.body);
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

module.exports.init = init;
module.exports.getAllExercises = getAllExercises;
module.exports.getExercise = getExercise;
module.exports.postExercise = postExercise;
module.exports.deleteExercise = deleteExercise;
module.exports.putExercise = putExercise;
