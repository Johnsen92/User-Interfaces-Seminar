'use strict';
const express = require("express");
const mysql = require("mysql"); 
const user = require("./user"); 
const exercise = require("./exercise"); 
const workout = require("./workout"); 

// Database Connection
const con = mysql.createConnection({
	host: "mysql",
	user: "test",
	password: "test"
});

// Connect to database
var database_connected = true;
try{
	con.connect((err) => {
		if (err) throw err;
		console.log("Connected!");
	});
	con.query("USE " + process.env.MYSQL_DATABASE, (err, result) => {
		if (err) throw err;
		console.log("Database selected");
	});
}
catch(err){
	console.log(err);
	database_connected = false;
}

if(!database_connected){
	console.log("We can't proceed without a database connection...exiting");
	return -1;
}

// Constants
const PORT = process.env.PORT;
const HOST = process.env.HOST;

// Init api modules
user.init("User", con);
exercise.init("Exercise", con);
workout.init("Workoutlog", con);

// App
const app = express();

// Enable JSON parsing in request bodies
app.use(express.json());

// Bind user functions
app.options("/users", user.optionsUser);
app.get("/users", user.getAllUsers);
app.get("/users/:id", user.getUser);
app.post("/users", user.postUser);
app.delete("/users/:id", user.deleteUser);
app.put("/users", user.putUser);

// Bind exercise functions
app.options("/exercise", exercise.optionsExercise);
app.get("/exercises", exercise.getAllExercises);
app.get("/exercises/:id", exercise.getExercise);
app.post("/exercises", exercise.postExercise);
app.delete("/exercises/:id", exercise.deleteExercise);
app.put("/exercises", exercise.putExercise);

// Bind workoutlog functions
app.options("/workouts", workout.optionsWorkoutlogs);
app.get("/workouts", workout.getAllWorkoutlogs);
app.get("/workouts/:id", workout.getWorkoutlog);
app.post("/workouts", workout.postWorkoutlog);
app.delete("/workouts/:id", workout.deleteWorkoutlog);
app.put("/workouts", workout.putWorkoutlog);

app.listen(PORT, HOST);
console.log(`Running on http://${HOST}:${PORT}`);