// Database connection
var con = null;
var module_name = "default";
var init_flag = false;

// Set database connection
function init(name, database_connection){
  con = database_connection;
  module_name = name;
  init_flag = true;
}

function getAllWorkoutlogs(req, res){
  // If not initiated yet, return
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }

  // Allow every origin (for developement purposes)
  res.setHeader("Access-Control-Allow-Origin",req.headers.origin);

  con.query("SELECT * FROM workoutlog", (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		res.send(JSON.stringify(result));
	});
};

function getWorkoutlog(req, res){
  // If not initiated yet, return
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }

  // Allow every origin (for developement purposes)
  res.setHeader("Access-Control-Allow-Origin",req.headers.origin);
  
	con.query("SELECT * FROM workoutlog WHERE WorkoutID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("WorkoutID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify(result));
	});
};

function postWorkoutlog(req, res){
  // If not initiated yet, return
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`INSERT INTO workoutlog (UserID, SessionID, ExerciseID, Reps, Weight, RPE, Timestamp) VALUES (
      '${req.body.UserID}',
      '${req.body.SessionID}',
      '${req.body.ExerciseID}',
      '${req.body.Reps}',
      '${req.body.Weight}',
      '${req.body.RPE}',
      '${req.body.Timestamp}')`
    );
    con.query(`SELECT * FROM workoutlog ORDER BY WorkoutID DESC LIMIT 1`, (err, result) => {
      res.send(JSON.stringify(result));        
    });
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

function deleteWorkoutlog(req, res){
  // If not initiated yet, return
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  con.query("DELETE FROM workoutlog WHERE WorkoutID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("WorkoutID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify("Success"));
	});
};

function putWorkoutlog(req, res){
  // If not initiated yet, return
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`UPDATE exercise SET
      UserID = '${req.body.UserID}',
      SessionID ='${req.body.SessionID}',
      ExerciseType = '${req.body.ExerciseType}'
      Reps = '${req.body.Reps}'
      Weight = '${req.body.Weight}'
      RPE = '${req.body.RPE}'
      Timestamp = '${req.body.Timestamp}'
      WHERE WorkoutID = ${req.body.WorkoutID}`
    );
    res.send(req.body);
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

module.exports.init = init;
module.exports.getAllWorkoutlogs = getAllWorkoutlogs;
module.exports.getWorkoutlog = getWorkoutlog;
module.exports.postWorkoutlog = postWorkoutlog;
module.exports.deleteWorkoutlog = deleteWorkoutlog;
module.exports.putWorkoutlog = putWorkoutlog;
