// Database connection
var con = null;
var module_name = "default";
var init_flag = false;

// Set database connection
function init(name, database_connection){
  con = database_connection;
  module_name = name;
  init_flag = true;
}

function getAllUsers(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  con.query("SELECT * FROM user", (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		res.send(JSON.stringify(result));
	});
};

function getUser(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
	con.query("SELECT * FROM user WHERE UserID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("UserID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify(result));
	});
};

function postUser(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`INSERT INTO user (UserName, UserMail, UserPassword, UserSalt) VALUES (
      '${req.body.UserName}',
      '${req.body.UserMail}',
      '${req.body.UserPassword}',
      '${req.body.UserSalt}')`
    );
    con.query(`SELECT * FROM user ORDER BY UserID DESC LIMIT 1`, (err, result) => {
      res.send(JSON.stringify(result));        
    });
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

function deleteUser(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  con.query("DELETE FROM user WHERE UserID = " + req.params.id, (err, result) => {
		if (err){
			console.log(err.message);
			return;
		}
		if(result.length == 0)
			res.status(404).send("UserID " + req.params.id + " has not been found");
		else
			res.send(JSON.stringify("Success"));
	});
};

function putUser(req, res){
  if(!init_flag){
    console.log("Module '" + module_name + "' has not been initialized");
    return;
  }
  try{
    con.query(`UPDATE user SET
      UserName = '${req.body.UserName}',
      UserMail ='${req.body.UserMail}',
      UserPassword = '${req.body.UserPassword}',
      UserSalt = '${req.body.UserSalt}'
      WHERE UserID = ${req.body.UserID}`
    );
    res.send(req.body);
  }
  catch(err){
    console.log(err.message);
    res.send(err.message);
  }
};

module.exports.init = init;
module.exports.getAllUsers = getAllUsers;
module.exports.getUser = getUser;
module.exports.postUser = postUser;
module.exports.deleteUser = deleteUser;
module.exports.putUser = putUser;
